<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beemote IA</title>
  <style>
    :root {
      --primary: #FFA500;
      --error: #f44336;
      --bg: #121212;
      --text: #ffffff;
    }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
    }
    #loading {
      text-align: center;
      margin-top: 50px;
    }
    #progress-bar {
      width: 100%;
      height: 10px;
      background: #333;
      margin: 20px 0;
      border-radius: 5px;
      overflow: hidden;
    }
    #progress {
      height: 100%;
      background: var(--primary);
      width: 0%;
      transition: width 0.3s;
    }
    #chat {
      display: none;
    }
    .error {
      color: var(--error);
    }
  </style>
</head>
<body>
  <div id="loading">
    <h1>üêù Beemote IA</h1>
    <p id="status">Inicializando...</p>
    <div id="progress-bar">
      <div id="progress"></div>
    </div>
    <p id="progress-text">0%</p>
    <button id="retry" style="display:none;">Tentar Novamente</button>
    <button id="lite" style="display:none;">Usar Vers√£o Simulada</button>
  </div>

  <div id="chat">
    <div id="messages" style="height: 70vh; overflow-y: auto;"></div>
    <input type="text" id="input" placeholder="Digite sua mensagem..." disabled>
    <button id="send" disabled>Enviar</button>
  </div>

  <script type="module">
    import { ChatModule } from 'https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.1.12';

    // Configura√ß√µes alternativas
    const MODEL_URLS = {
      'TinyLlama': {
        model: 'TinyLlama-1.1B-Chat-v0.3-q4f16_1',
        wasm: 'https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.1.12/dist/TinyLlama-1.1B-Chat-v0.3-q4f16_1-webgpu.wasm'
      },
      'Phi-2': {
        model: 'phi-2-q4f16_1',
        wasm: 'https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.1.12/dist/phi-2-q4f16_1-webgpu.wasm'
      }
    };

    // Elementos da UI
    const loadingEl = document.getElementById('loading');
    const chatEl = document.getElementById('chat');
    const statusEl = document.getElementById('status');
    const progressEl = document.getElementById('progress');
    const progressTextEl = document.getElementById('progress-text');
    const retryBtn = document.getElementById('retry');
    const liteBtn = document.getElementById('lite');

    // Estado do aplicativo
    let chat;
    let currentModel = 'TinyLlama';
    let fallbackMode = false;

    async function initModel() {
      try {
        statusEl.textContent = 'Carregando modelo...';
        retryBtn.style.display = 'none';
        liteBtn.style.display = 'none';
        
        chat = new ChatModule();
        
        // Configura√ß√£o alternativa de URL
        await chat.setInitConfig({
          wasmUrl: MODEL_URLS[currentModel].wasm,
          modelUrl: `https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.1.12/dist/${MODEL_URLS[currentModel].model}-webgpu.wasm`
        });

        chat.setInitProgressCallback((report) => {
          const percent = Math.round(report.progress * 100);
          progressEl.style.width = `${percent}%`;
          progressTextEl.textContent = `${percent}%`;
          statusEl.textContent = report.text || 'Carregando...';
        });

        await chat.reload(MODEL_URLS[currentModel].model);
        
        // Sucesso - mostra a interface do chat
        loadingEl.style.display = 'none';
        chatEl.style.display = 'block';
        document.getElementById('input').disabled = false;
        document.getElementById('send').disabled = false;
        
        // Mensagem inicial
        addMessage('Ol√°! Eu sou a Beemote IA. Como posso ajudar?', 'bot');
        
      } catch (error) {
        console.error('Erro ao carregar modelo:', error);
        statusEl.textContent = 'Erro ao carregar o modelo';
        statusEl.className = 'error';
        retryBtn.style.display = 'inline-block';
        liteBtn.style.display = 'inline-block';
      }
    }

    function addMessage(text, sender) {
      const msgEl = document.createElement('div');
      msgEl.textContent = text;
      msgEl.style.margin = '10px 0';
      msgEl.style.padding = '10px';
      msgEl.style.borderRadius = '5px';
      msgEl.style.backgroundColor = sender === 'bot' ? 'rgba(129, 199, 132, 0.2)' : 'rgba(79, 195, 247, 0.2)';
      document.getElementById('messages').appendChild(msgEl);
    }

    // Vers√£o simulada (fallback)
    function initLiteVersion() {
      fallbackMode = true;
      loadingEl.style.display = 'none';
      chatEl.style.display = 'block';
      document.getElementById('input').disabled = false;
      document.getElementById('send').disabled = false;
      addMessage('Voc√™ est√° no modo simulado. Recarregue para tentar o modo completo.', 'bot');
    }

    // Event listeners
    document.getElementById('send').addEventListener('click', async () => {
      const input = document.getElementById('input');
      const text = input.value.trim();
      if (!text) return;
      
      addMessage(text, 'user');
      input.value = '';
      
      if (fallbackMode) {
        setTimeout(() => {
          addMessage('Eu sou a Beemote IA no modo simulado. Recarregue a p√°gina para tentar o modo completo.', 'bot');
        }, 1000);
        return;
      }
      
      try {
        const reply = await chat.generate(text);
        addMessage(reply, 'bot');
      } catch (error) {
        addMessage('Ocorreu um erro ao gerar a resposta', 'error');
      }
    });

    retryBtn.addEventListener('click', initModel);
    liteBtn.addEventListener('click', initLiteVersion);

    // Inicia o aplicativo
    initModel();
  </script>
</body>
</html>
